# ドキュメント・コード・テストの三位一体同期管理

## 概要

ドキュメント、コード、テストの三要素を常に同期させ、プロジェクトの整合性と品質を保つための方針です。

## 基本原則

### 三位一体の関係

```
ドキュメント ←→ コード ←→ テスト
     ↑                      ↓
     └────────────────────────┘
```

**三要素は最終的に完全に同期されるべき**
- ドキュメント: 設計意図と仕様を記述
- コード: 実際の動作を実装
- テスト: 仕様と動作を保証

### 同期の基本戦略

**「どれが正か」を判断し、正しいものに他を合わせる**

1. **通常の開発フロー**: コード → テスト → ドキュメント
   - 実装が先行し、動作を確認してから文書化

2. **設計駆動開発**: ドキュメント → テスト → コード
   - 仕様を定義し、テストを書いてから実装

3. **テスト駆動開発**: テスト → コード → ドキュメント
   - 期待動作を定義し、実装してから文書化

## 同期確認の実践

### 1. 正の判定基準

**状況別の「正」の判定**

| 状況 | 正とすべきもの | 理由 |
|------|--------------|------|
| 実装済み機能の修正 | コード | 実際に動作しているものが真実 |
| 新機能の設計 | ドキュメント | 設計意図が最も重要 |
| バグ修正 | テスト | 期待動作を明確に定義 |
| リファクタリング | テスト | 動作を変えずに実装を改善 |
| 仕様変更 | ドキュメント | 新しい仕様を起点に修正 |

### 2. 不一致の検出

**三要素間の不一致パターン**

- **D-C不一致**: ドキュメントの説明とコードの動作が異なる
- **C-T不一致**: コードの実装とテストの期待値が異なる
- **T-D不一致**: テストの仕様とドキュメントの記載が異なる
- **D-C-T不一致**: 三要素すべてが異なる（最も深刻）

### 3. 同期の実行手順

1. **現状把握**
   - 三要素それぞれの状態を確認
   - 不一致の箇所と種類を特定
   - 最後に更新された要素を確認

2. **正の決定**
   - 上記の判定基準に従って「正」を決定
   - 不明な場合は実際の動作（コード）を優先
   - 設計意図が重要な場合はユーザーに確認

3. **同期作業**
   - 正とした要素に他の要素を合わせる
   - 修正の順序: 依存関係の少ない要素から
   - 各修正後に整合性を確認

## チェックポイント

### 必須確認項目

**ドキュメント**
- [ ] APIの仕様が実装と完全一致
- [ ] 使用例が実際に動作する
- [ ] エラーケースの説明が正確

**コード**
- [ ] ドキュメントに記載された機能を実装
- [ ] テストケースをすべてパス
- [ ] エッジケースの処理が適切

**テスト**
- [ ] ドキュメントの仕様を網羅
- [ ] コードの全機能を検証
- [ ] 正常系・異常系の両方をカバー

### 同期の品質指標

- **カバレッジ**: テストが仕様とコードをどれだけカバーしているか
- **一致度**: 三要素間で記述が一致している割合
- **更新頻度**: 各要素が適切に更新されているか
- **トレーサビリティ**: 要素間の対応関係が明確か

## トレーサビリティの確保

### コメントとテストタイトルの役割

**ドキュメントとの関連性を明示的に記述する意義**

ドキュメントが充実していても、コードとテストには適切なコメントが必要です。これらは異なる役割を持ち、相互補完的に機能します。

#### コード内コメントの意義

**役割**:
- ドキュメントへの参照ポイントを提供
- 実装意図とドキュメント記載の関連を明確化
- コードレビュー時の仕様確認を容易に
- 将来の変更時に影響範囲を把握しやすく

#### テストタイトルの意義

**役割**:
- テストが検証している仕様を明確化
- テスト失敗時にどの仕様が満たされていないか即座に判断
- カバレッジ分析時に仕様網羅性を確認
- ドキュメント更新時の影響テストを特定

### コメント省略の誤解

**ドキュメント整備 ≠ コメント不要**

| 要素 | 記載内容 | 読者 |
|------|---------|------|
| ドキュメント | 全体像・仕様・使い方 | エンドユーザー・開発者 |
| コードコメント | 実装意図・制約・参照 | 実装者・保守担当者 |
| テストタイトル | 検証内容・仕様参照 | テスト実行者・QA |

それぞれが異なる文脈で読まれ、異なる情報を提供します。

## 継続的同期のプラクティス

### 変更時のルール

1. **コード変更時**
   - 関連テストの更新または追加
   - 影響を受けるドキュメントの更新

2. **ドキュメント変更時**
   - 仕様変更の場合はテストを先に更新
   - 説明改善の場合はコードとの一致を確認

3. **テスト変更時**
   - 仕様変更を反映している場合はドキュメント更新
   - バグ修正の場合はコードを修正
   - テストの意図を明確に記述

## 優先順位

1. **最優先**: 機能に影響する不一致
2. **高優先**: ユーザーに見える不一致
3. **中優先**: 内部仕様の不一致
4. **低優先**: 表記や文言の不統一

## sebas-chan プロジェクトでの適用例

### ワークフロー開発での同期

1. **新規ワークフロー作成時**
   - `docs/workflows/SPECIFICATION.md` で仕様定義
   - テストファイル作成（*.test.ts）
   - 実装ファイル作成（impl-functional/*.ts）
   - 三要素の整合性確認

2. **既存ワークフロー修正時**
   - 修正内容に応じて「正」を決定
   - バグ修正: テストが正
   - 機能追加: ドキュメントが正
   - リファクタリング: テストが正

### データモデル変更での同期

1. **型定義の変更**
   - `packages/shared-types/src/index.ts` の型定義
   - `docs/architecture/INFORMATION_MODEL.md` のドキュメント
   - 関連するテストケース
   - すべてを同時に更新

2. **API変更**
   - `docs/architecture/INTERFACES.md` の仕様
   - 実装コード
   - APIテスト
   - 変更の影響範囲を明確に

---
**作成日**: 2025年9月19日
**用途**: sebas-chanプロジェクトにおけるドキュメント・コード・テストの三位一体同期管理