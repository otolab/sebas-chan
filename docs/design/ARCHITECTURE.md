# sebas-chan システムアーキテクチャ

## システム概要

sebas-chanは、ユーザーの認知的負荷を軽減するための自律型AIエージェントシステムです。イベント駆動型アーキテクチャにより、情報の収集・分析・管理を自動化します。

## アーキテクチャ原則

### 設計思想
- **イベント駆動**: 全ての処理はイベントをトリガーとして実行
- **疎結合**: コンポーネント間の依存を最小化
- **段階的拡張**: 最小構成から機能を追加
- **型安全**: TypeScriptによる静的型付け

### 制約事項
- 単一プロセスで動作（現時点）
- 同期的なDB操作
- インメモリイベントキュー

## システム構造

### 全体アーキテクチャ

```
┌──────────────────────────────────────────────────────┐
│                    Server Process                     │
│                  (@sebas-chan/server)                 │
│  ┌────────────────────────────────────────────────┐  │
│  │             Core Engine (制御層)                │  │
│  │  ┌──────────────────────────────────────────┐  │  │
│  │  │          REST API エンドポイント          │  │  │
│  │  └──────────────────────────────────────────┘  │  │
│  │         ↓                       ↓              │  │
│  │  ┌──────────────┐     ┌──────────────────┐  │  │
│  │  │ Event Queue   │     │ WorkflowContext   │  │  │
│  │  └──────────────┘     └──────────────────┘  │  │
│  └────────────────────────────────────────────────┘  │
│                      ↓                               │
│  ┌────────────────────────────────────────────────┐  │
│  │          Core Agent (思考エンジン)              │  │
│  │            (@sebas-chan/core)                  │  │
│  └────────────────────────────────────────────────┘  │
│                      ↓                               │
│  ┌────────────────────────────────────────────────┐  │
│  │      DB Bridge → Python/LanceDB                │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
           ↑               ↑               ↑
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │Reporters │    │  Web UI  │    │MCP Server│
    │          │    │(SvelteKit)│    │ (Phase4) │
    └──────────┘    └──────────┘    └──────────┘
```

### レイヤー責務

| レイヤー | 責務 | 主要コンポーネント |
|---------|------|-----------------|
| インターフェース層 | 外部通信 | REST API, Web UI, Reporters |
| 制御層 | システム制御 | Core Engine, Event Queue |
| 処理層 | ビジネスロジック | Core Agent, Workflows |
| データ層 | 永続化 | DB Bridge, LanceDB |

## コンポーネント設計

### Core Engine（@sebas-chan/server）
システムの中核制御コンポーネント

**責務**:
- REST APIエンドポイント提供
- イベントキュー管理
- ワークフロー登録・実行制御

**インターフェース**:
- HTTP REST API（Express）
- WebSocket（将来実装）

### Core Agent（@sebas-chan/core）
ワークフロー実行エンジン

**責務**:
- ワークフロー実行
- AIドライバー管理
- 状態管理

**設計パターン**:
- イベントループ
- ステートレス実行

### DB Bridge（@sebas-chan/db）
データアクセス層

**責務**:
- TypeScript/Python間のブリッジ
- ベクトル検索
- データ永続化

**通信方式**:
- JSON-RPC over stdio

## データアーキテクチャ

### 情報モデル

```
Input（生データ）
  ↓ 取り込み
Pond（未整理情報）
  ↓ 分析・整理
Issue（課題）← 解決 → Knowledge（知識）
```

### データストア

| ストア | 用途 | 特性 |
|--------|------|------|
| Pond | 一時保管 | 全データ保存、検索可能 |
| Issues | 課題管理 | 状態管理、優先度付き |
| Knowledge | 知識ベース | ベクトル検索、評価付き |

## 通信アーキテクチャ

### イベントフロー

```
外部トリガー → Event生成 → 優先度キュー → Workflow実行 → 新Event
                              ↓
                         条件評価・フィルタ
```

### 優先度設計

| 優先度 | 用途 | 処理時間目標 |
|--------|------|------------|
| 80-100 | クリティカル | < 100ms |
| 50-79 | ユーザー応答 | < 500ms |
| 0-49 | 通常処理 | < 5s |
| -100--1 | バックグラウンド | ベストエフォート |

## ワークフローアーキテクチャ

### ワークフロー分類

| 系統 | 役割 | 例 |
|------|------|-----|
| A系 | 基本処理 | Input取込、User要求処理 |
| B系 | 横断処理 | クラスタリング、関係更新 |
| C系 | 提案 | 次アクション提案 |
| D系 | 自己調整 | システム最適化 |

### 実行モデル
- **単独実行**: 1イベント → 1ワークフロー
- **チェーン実行**: 連続的なワークフロー実行
- **並列実行**: 複数ワークフローの同時実行

## スケーラビリティ

### 現在の実装（Phase 3）
- 単一プロセス
- インメモリキュー
- 同期処理

### 将来の拡張（Phase 4+）
- マルチプロセス/マルチスレッド
- 永続化キュー（Redis等）
- 非同期処理
- 水平スケーリング

## セキュリティ

### アクセス制御
- API認証（将来実装）
- ロールベースアクセス制御（将来実装）

### データ保護
- 環境変数による機密情報管理
- ログのサニタイズ
- HTTPS通信（本番環境）

## 障害対策

### エラーハンドリング
- 階層的エラー処理
- エラーイベント発行
- 自動リトライ（一時的エラー）

### 監視・ログ
- WorkflowRecorderによる実行記録
- 構造化ログ
- メトリクス収集（将来実装）

## 技術スタック

### 言語・フレームワーク
- **TypeScript**: メイン開発言語
- **Python**: LanceDB連携
- **Express**: REST API
- **SvelteKit**: Web UI

### データベース
- **LanceDB**: ベクトルDB
- **ruri-v3**: 日本語埋め込みモデル

### AI基盤
- **moduler-prompt**: プロンプト管理
- **AIService**: ドライバー抽象化

## パッケージ構成

```
packages/
├── server/         # Core Engine実装
├── core/           # Core Agent実装
├── db/             # DB Bridge実装
├── shared-types/   # 共通型定義
├── web-ui/         # Web UI
├── reporter-sdk/   # Reporter開発SDK
└── mcp-server/     # MCP Server（Phase 4）
```

## 関連ドキュメント

### 設計詳細
- [コンポーネント詳細](./COMPONENTS.md)
- [技術的決定事項](./TECHNICAL_DECISIONS.md)
- [Core Engine/Agent仕様](./CORE_ENGINE_AGENT_SPEC.md)

### ワークフロー
- [ワークフロー仕様](../workflows/SPECIFICATION.md)
- [開発者ガイド](../workflows/DEVELOPER_GUIDE.md)

### データ設計
- [情報モデル](../data/INFORMATION_MODEL.md)
- [LanceDBスキーマ](../data/LANCEDB_SCHEMA.md)

### API
- [内部インターフェース](../api/INTERNAL_INTERFACES.md)