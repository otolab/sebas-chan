# 仕様ブラッシュアップ作業計画

## 目的

コード実装から一度離れ、event-workflow-catalog.mdを完全で一貫性のある仕様書として確立する。
これを唯一の正（Single Source of Truth）として、今後のコード修正の基準とする。

## 作業フェーズ

### Phase 1: 現状分析と課題整理（完了済み）
- ✅ 実装で使用されているイベントの洗い出し
- ✅ 設計文書との差異分析
- ✅ リスナー不在のイベント特定
- ✅ SUGGESTED系イベントの問題点指摘

**成果物**:
- EVENT_MATRIX_ANALYSIS.md
- NEW_EVENTS_PROPOSAL.md

### Phase 2: イベント設計の精査（これから）

#### 2.1 新規イベント11個の妥当性検証

各イベントについて以下を検討：

1. **UNCLUSTERED_ISSUES_EXCEEDED**
   - 必要性：未整理Issueの自動整理トリガー
   - 受信者：B-1 (ClusterIssues)
   - 代替案：SCHEDULE_TRIGGEREDで定期実行？
   - 判定：？

2. **ISSUE_STALLED**
   - 必要性：停滞Issueへの対応
   - 受信者：C-2 (SuggestNextAction)
   - 代替案：SCHEDULE_TRIGGEREDで定期チェック？
   - 判定：？

3. **POND_CAPACITY_WARNING**
   - 必要性：容量管理
   - 受信者：B-4 (SalvageFromPond)
   - 代替案：システム内部で処理？
   - 判定：？

4. **MAINTENANCE_REQUIRED**
   - 必要性：メンテナンス通知
   - 受信者：D-1 (TuneSystemParameters)？
   - 代替案：SCHEDULE_TRIGGERED？
   - 判定：？

5. **FLOW_RELATIONS_CHANGED**
   - 必要性：Flow変更の記録と連鎖処理
   - 受信者：B-3 (UpdateFlowPriorities)？
   - 代替案：なし（記録として必要）
   - 判定：？

6. **FLOW_ARCHIVED**
   - 必要性：アーカイブ完了通知
   - 受信者：ログ記録のみ？
   - 代替案：FLOW_STATUS_CHANGED？
   - 判定：？

7. **FLOW_CREATED**
   - 必要性：新規Flow作成通知
   - 受信者：B-2 (UpdateFlowRelations)
   - 代替案：なし（重要なイベント）
   - 判定：？

8. **ISSUES_CLUSTER_DETECTED**
   - 必要性：クラスター検出からFlow作成へ
   - 受信者：新規ワークフロー必要？
   - 代替案：B-1内で直接Flow作成？
   - 判定：？

9. **ESCALATION_REQUIRED**
   - 必要性：緊急対応の通知
   - 受信者：通知システム？
   - 代替案：HIGH_PRIORITY_ISSUE_DETECTED？
   - 判定：？

10. **PERSPECTIVE_TRIGGERED**
    - 必要性：重要な観点の発見通知
    - 受信者：ユーザー通知？
    - 代替案：FLOW_UPDATEDに含める？
    - 判定：？

11. **KNOWLEDGE_APPLIED**
    - 必要性：知識活用の追跡
    - 受信者：A-3 (ExtractKnowledge)で学習？
    - 代替案：ログ記録のみ？
    - 判定：？

#### 2.2 ワークフロー連携パターンの再設計

以下の観点で整理：
- データ駆動パターン
- 時間駆動パターン
- しきい値駆動パターン
- ユーザー駆動パターン

### Phase 3: event-workflow-catalog.md更新

#### 3.1 構造の整理
```
1. イベント定義
   - イベント一覧（カテゴリ別）
   - 各イベントの詳細仕様
   - ペイロード定義

2. ワークフロー定義
   - ワークフロー一覧
   - トリガーイベント
   - 発行イベント
   - 優先度

3. イベント送受信マトリクス
   - 送信マトリクス（誰が何を発行）
   - 受信マトリクス（誰が何を受信）
   - 連携フロー図

4. 実装ガイドライン
   - イベント命名規則
   - ペイロード設計原則
   - エラーハンドリング
```

#### 3.2 不足しているワークフローの検討

- Flow作成ワークフロー（ISSUES_CLUSTER_DETECTED受信）
- 通知ワークフロー（ESCALATION_REQUIRED受信）
- B-3, B-4, B-5の実装要否

### Phase 4: 仕様検証

#### 4.1 整合性チェック
- すべてのイベントに受信者が存在するか
- 循環参照がないか
- デッドロックの可能性がないか
- 優先度の矛盾がないか

#### 4.2 完全性チェック
- 主要なユースケースがカバーされているか
- エラーケースの考慮
- 将来の拡張性

### Phase 5: 実装計画策定

仕様確定後：
1. 実装優先順位の決定
2. 段階的移行計画
3. テスト戦略

## 留意点

### 1. 設計原則の遵守

#### イベント設計
- **問題の先送りを避ける**：SUGGESTEDイベントは原則禁止
- **明確な受信者**：発火したイベントは必ず処理される
- **単一責任**：1イベント1目的

#### ワークフロー設計
- **自己完結性**：可能な限りワークフロー内で完結
- **疎結合**：イベントを介した緩い連携
- **冪等性**：同じイベントを複数回受信しても安全

### 2. システムの本質を見失わない

#### Issueの正しい理解
- Issue = ユーザーが追跡したい事項
- NOT バグレポート、問題報告

#### Flowの役割
- Flow = Issueに「観点」を与える枠組み
- 動的で柔軟な整理手段

#### 「忘れさせる」という目的
- ユーザーの認知負荷を下げる
- AIが適切なタイミングでリマインド

### 3. 実装の現実を考慮

#### パフォーマンス
- イベントの発火頻度
- ワークフローの実行コスト
- 優先度による制御

#### 段階的実装
- コアとなるイベント・ワークフローから
- 徐々に高度な連携へ

### 4. ドキュメントの一貫性

#### 唯一の正
- event-workflow-catalog.mdを仕様の正とする
- 他のドキュメントは参照・補助資料

#### 更新の同期
- EVENT_CATALOG.md（イベント定義の詳細）
- WORKFLOW_TRIGGER_EVENTS.md（トリガー一覧）
- 各ワークフローのREADME.md

### 5. 変更の影響範囲

#### 既存コードへの影響
- 破壊的変更の最小化
- 移行パスの明確化

#### テストへの影響
- テストケースの見直し
- 新規テストの必要性

## 成功基準

1. **明確性**：誰が読んでも理解できる仕様
2. **完全性**：すべてのイベントに明確な送信者と受信者
3. **一貫性**：命名規則、設計原則の統一
4. **実装可能性**：現実的に実装可能な設計
5. **拡張性**：将来の機能追加を妨げない

## 次のアクション

1. 11個の新規イベントそれぞれの必要性を○△×で評価
2. 必要と判断されたイベントの受信ワークフローを明確化
3. ワークフロー間の連携フローを図示
4. event-workflow-catalog.mdの更新案作成
5. レビューと修正
6. 最終版の確定