# ワークフローイベント駆動設計

## 1. イベント駆動の本質

### イベントとは何か

イベントとは「何かが起きたこと」の通知です。システムの状態変化や外部からの入力を表現します。

- **イベント** = 起きた事実の記録
- **ワークフロー** = イベントに対する反応・処理

重要なのは、イベントそのものは「何をすべきか」を含まないことです。処理はワークフローが決定します。

## 2. A系列ワークフローの本質的な仕様

### A-0: ユーザーリクエスト処理

#### 本質的な役割

ユーザーリクエストという「極めて特殊で予測不可能なイベント」を解釈し、システムが理解できる構造化されたイベントに変換する。

#### なぜ特殊なのか

- **内容が予測不可能**: 自然言語で表現され、意図が曖昧
- **複数の意図を含む可能性**: 1つのリクエストに複数の要求が混在
- **コンテキスト依存**: 同じ文言でも状況により意味が変わる
- **後続が無限**: どんなイベントでも発生しうる

#### 何を得るか

- ユーザーからの自然言語テキスト
- リクエストのコンテキスト（ユーザーID、タイムスタンプ、セッション情報）
- システムの現在状態

#### 何をするか

1. **意図の解釈**: 自然言語を理解し、ユーザーが本当に求めていることを推測
2. **複数意図の分解**: 複合的なリクエストを個別の要求に分解
3. **コンテキスト補完**: 不足している情報を推測・補完
4. **優先度判定**: 複数の要求がある場合の処理順序を決定
5. **適切なイベント生成**: システムが処理可能な具体的イベントへ変換

#### 何を出すか（イベントとして）

- 追跡すべき事項が含まれる場合 → `ISSUE_REPORTED`イベント
- 質問が含まれる場合 → `QUESTION_ASKED`イベント
- データ入力の場合 → `DATA_RECEIVED`イベント
- 指示・命令の場合 → `ACTION_REQUESTED`イベント
- 不明瞭な場合 → `CLARIFICATION_NEEDED`イベント

**重要**: 1つのユーザーリクエストから複数のイベントが生成される可能性がある

---

### A-1: データ取り込み

#### 本質的な役割

外部から到着したデータ（構造化/非構造化）を永続化し、システムが後で活用できる形で保存する。さらに、緊急対応が必要な兆候を検出する。

#### 何を得るか

- 様々なソースからのデータ（ログ、レポート、メトリクス等）
- データのメタデータ（ソース、タイムスタンプ、形式）
- 取り込みのコンテキスト

#### 何をするか

1. **データの永続化**: Pondへの保存（ベクトル埋め込み付き）
2. **内容の理解**: データが何を表現しているかを分析
3. **重要パターン検出**: 繰り返し、期限、重要度の識別
4. **重要度評価**: 即座の対応が必要かを判定
5. **メタデータ抽出**: 後の検索・分析のための情報抽出

#### 何を出すか（イベントとして）

- 重要パターン検出時 → `PATTERN_FOUND`イベント
- 重要情報を含む場合 → `SIGNIFICANT_DATA_RECEIVED`イベント
- 通常のデータ → イベント発行なし（保存のみ）

---

### A-2: 影響分析

#### 本質的な役割

ユーザーが追跡している事項の現在の状態と影響を分析し、優先度を適切に設定してユーザーが注目すべき事項を明確化する。

#### 何を得るか

- 追跡事項の詳細（内容、期限、関連情報）
- 発生コンテキスト（時刻、環境、関連システム）
- 過去の類似事項

#### 何をするか

1. **影響範囲の特定**: 他の追跡事項やユーザーの活動への影響を分析
2. **重要度評価**: ユーザーにとっての重要度を推定
3. **緊急度分析**: 期限や時間的制約を評価
4. **関連事項の発見**: 類似または依存関係にある事項を特定
5. **対応優先度の決定**: 緊急度と重要度から優先度を算出

#### 何を出すか（イベントとして）

- 高優先度の追跡事項 → `CRITICAL_ISSUE_IDENTIFIED`イベント
- パターンが発見された場合 → `PATTERN_DETECTED`イベント
- 知識化可能な場合 → `KNOWLEDGE_EXTRACTABLE`イベント
- 追加調査が必要 → `INVESTIGATION_NEEDED`イベント

---

### A-3: 知識抽出

#### 本質的な役割

ユーザーが完了した追跡事項や経験から再利用可能な知識を抽出し、将来同様の事項に対処する際に活用できる形で構造化・保存する。

#### 何を得るか

- 完了した追跡事項とその対処方法
- 質問と回答のペア
- 発見されたパターンやベストプラクティス
- 失敗事例と教訓

#### 何をするか

1. **知識の識別**: 再利用価値のある情報を特定
2. **一般化**: 特定の事例から汎用的な知識へ抽象化
3. **構造化**: 検索・適用可能な形式に整理
4. **関連付け**: 既存知識との関係性を確立
5. **信頼度評価**: 知識の確実性・適用範囲を評価

#### 何を出すか（イベントとして）

- 新しいパターン発見 → `NEW_PATTERN_DISCOVERED`イベント
- 既存知識の更新 → `KNOWLEDGE_UPDATED`イベント
- 矛盾の発見 → `KNOWLEDGE_CONFLICT_DETECTED`イベント
- 通常は終端（イベント発行なし）

## 3. イベントの本質的な分類

### 外部イベント（External Events）

システム外部から到着するイベント：

- `USER_REQUEST_RECEIVED`: ユーザーからのリクエスト
- `DATA_ARRIVED`: 外部システムからのデータ到着
- `SCHEDULED_TIME_REACHED`: スケジュール時刻到達

### 状態変化イベント（State Change Events）

システム内部の状態変化を表すイベント：

- `ISSUE_CREATED`: 新しい問題が記録された
- `KNOWLEDGE_STORED`: 知識が保存された
- `THRESHOLD_EXCEEDED`: 閾値を超えた

### 発見イベント（Discovery Events）

分析や処理の結果、何かを発見したことを表すイベント：

- `PATTERN_FOUND`: パターンを発見
- `PATTERN_FOUND`: パターンを発見
- `ANOMALY_IDENTIFIED`: 異常を特定

### アクションイベント（Action Events）

何らかのアクションが必要であることを示すイベント：

- `INVESTIGATION_NEEDED`: 調査が必要
- `APPROVAL_REQUIRED`: 承認が必要
- `NOTIFICATION_REQUESTED`: 通知を要求

## 4. ワークフローとイベントの正しい関係

### 原則

1. **ワークフローはイベントに反応する**: イベントがトリガー
2. **ワークフローは新たなイベントを生成できる**: 処理の結果として
3. **イベントは事実を表現**: 「何が起きたか」であり「何をすべきか」ではない
4. **ワークフローが判断する**: イベントに対して何をするかはワークフローが決定

### 設計指針

1. **イベント名は過去形または完了形**: 起きたことを表現
   - 良い例: `USER_REQUEST_RECEIVED`, `ERROR_DETECTED`
   - 悪い例: `PROCESS_REQUEST`, `ANALYZE_ERROR`

2. **イベントペイロードは事実のみ**: 処理指示を含まない
   - 良い例: `{ errorMessage, timestamp, source }`
   - 悪い例: `{ action: 'analyze', priority: 'high' }`

3. **ワークフローは複数のイベントを発行可能**: 必要に応じて
4. **ワークフローは選択的に反応**: conditionで詳細な条件を定義

## 5. A系列ワークフローの改善方向

### A-0の改善点

- **柔軟な意図理解**: より複雑なユーザーリクエストへの対応
- **マルチイベント生成**: 1つのリクエストから適切に複数イベントを生成
- **コンテキスト保持**: セッション情報を活用した文脈理解

### A-1の改善点

- **スマート分析**: AIを活用したデータ内容の深い理解
- **プロアクティブ検出**: 明示的エラー以外の異常兆候も検出
- **リッチメタデータ**: より詳細な検索・分析のための情報抽出

### A-2の改善点

- **ホリスティック分析**: システム全体の状態を考慮した影響評価
- **予測的分析**: 将来の影響可能性も含めた分析
- **自動優先度調整**: 動的な状況変化に応じた優先度更新

### A-3の改善点

- **自動一般化**: 特定事例から汎用知識への自動変換
- **知識グラフ構築**: 知識間の関係性ネットワーク構築
- **信頼度の動的更新**: 利用実績に基づく知識の信頼度調整

## 6. まとめ

ワークフローの本質は「何が起きたか」（イベント）に対して「何をするか」を決定し実行することです。特にユーザーリクエストは極めて特殊なイベントであり、その柔軟性と予測不可能性に対応できる設計が必要です。

重要なのは：

1. イベントは事実の通知
2. ワークフローは反応と処理
3. 型よりも「何を得て、何をして、何を出すか」の明確化
4. 特にユーザーリクエストは無限の可能性を持つ

この理解に基づいて、各ワークフローを設計・実装することが重要です。
