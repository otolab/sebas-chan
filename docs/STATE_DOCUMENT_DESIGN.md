# State文書の設計思想

## 概要

State文書は、sebas-chanシステムにおける「現在のコンテキスト」を保持する唯一無二のワーキングメモリです。構造化されていない単一の自然言語ドキュメントとして、システムの柔軟な判断を可能にします。

## なぜState文書が必要なのか

### 判断の「自明性」を支えるコンテキスト

多くの優先度判断や価値判定は、実は「自明」です：
- 締切が明日の仕事と来月の仕事、どちらが優先か
- 体調が悪い時に無理をすべきか休むべきか
- 今日は金曜日だから軽いタスクから始めるか

これらが「自明」であるために必要なのは、正しい**コンテキスト**です。

### 構造化データの限界

従来のタスク管理システムは、優先度を数値で、期限を日付で、カテゴリをタグで管理します。しかし、人間の判断は以下のような曖昧な情報に基づいています：

```
今週は体調がイマイチで、集中力が続かない。
明日は重要な会議があるから、今日中に資料を仕上げたい。
最近、プロジェクトAが炎上気味で、そっちに時間を取られている。
```

これらの情報を構造化データに落とし込むことは困難であり、無理に構造化すると本質的な情報が失われます。

## State文書の特徴

### 1. 非構造化

Key-Valueストアではなく、単一の自然言語テキストです：

```typescript
// これはState文書ではない（構造化されている）
{
  "currentFocus": "プロジェクトA",
  "health": "poor",
  "deadline": "2024-03-15"
}

// これがState文書（自然言語）
"""
最近プロジェクトAに追われている。体調もあまり良くない。
3月15日の締切までに仕上げないといけないが、正直きつい。
"""
```

### 2. 曖昧性の許容

State文書は曖昧な表現を許容し、むしろ推奨します：

- 「なんとなく不安」
- 「多分大丈夫だと思う」
- 「急ぎではないけど重要」

これらの曖昧な情報こそが、AIの柔軟な判断を可能にします。

### 3. 時系列性

State文書は常に「今」を表現します：

- 過去の記録ではない（それはPondの役割）
- 未来の計画ではない（それはFlowの役割）
- 「現在の状況と気持ち」を記録

## State文書の活用例

### Flow優先度判定（B-3）での活用

```typescript
// State文書から抽出される情報
const stateContext = await extractContext(stateDocument); // 生成AIによるる分解
>>> 「自然言語の機械的な分解」は行いません。

>>> { xxx: healthCondition, yyy: 忙しさ } = stateContext; // 構造化レスポンス

// 例：「今週は体調が悪い」という記述から
if (stateContext.includes("体調") && stateContext.includes("悪い")) {
  // 負荷の低いタスクの優先度を上げる
  lightTaskPriority *= 1.2;
  heavyTaskPriority *= 0.8;
}

// 例：「明日締切」という記述から
if (stateContext.includes("明日") && stateContext.includes("締切")) {
  // 該当するFlowの緊急度を最大に
  urgencyFactor = 1.0;
}
```

### ユーザーとの対話での活用

>>> 機械的な判断は行いません。単純にChatAgentが参照する資料として利用されます

```typescript
// State文書の内容に基づいて質問を生成
if (stateDocument.includes("迷っている")) {
  return {
    userQuery: {
      type: 'clarify_context',
      message: "何について迷っていますか？優先順位の判断をお手伝いします。",
      options: ["作業の順序", "やるべきかどうか", "その他"]
    }
  };
}
```

## State文書の更新

### 誰が更新するか

1. **ユーザー**: 直接編集、自然言語での追記
2. **ワークフロー**: 実行結果の要約を追記
3. **システム**: 定期的な整理・要約（将来実装）

### 更新のタイミング

- ユーザーリクエスト処理後
- 重要な判断の後
- 状況の大きな変化時
- 定期的な振り返り時

## 実装上の注意点

### 1. サイズ管理

State文書が巨大になりすぎないよう、定期的な要約・整理が必要です：

```typescript
const MAX_STATE_SIZE = 10000; // 文字数
if (stateDocument.length > MAX_STATE_SIZE) {
  // 古い情報を要約・アーカイブ
  const summary = summarizeOldContext(stateDocument);
  stateDocument = summary + getRecentContext(stateDocument);
}
```

### 2. プライバシー

State文書には極めて個人的な情報が含まれる可能性があります：

- 健康状態
- 人間関係
- 仕事の機密情報

これらは完全にローカルで管理され、外部に送信されることはありません。

### 3. AIへの入力

State文書全体をAIに渡す際は、トークン数の制限に注意：

```typescript
// 関連部分のみを抽出
const relevantContext = extractRelevantParts(stateDocument, currentTask);

// AIへの入力に含める
const prompt = `
現在のコンテキスト：
${relevantContext}

この状況で、以下のFlowの優先度をどう判断しますか？
`;
```

## State文書とB-3/B-4の関係

### B-3（優先度判定）における役割

State文書は優先度判定の**最重要入力**です：

- 数値化できない要因の考慮
- 個人の状況に応じた調整
- 「自明な判断」の実現

### B-4（サルベージ）における役割

State文書はサルベージの**観点生成**に活用されます：

- 現在の関心事からの観点
- 忘れかけている重要事項の発見
- コンテキストに応じた価値判定

## まとめ

State文書は、構造化データでは表現できない「人間らしい曖昧さ」を保持し、AIの柔軟な判断を可能にする重要な仕組みです。これにより、sebas-chanは単なるタスク管理ツールではなく、ユーザーの状況を理解する「外部脳」として機能します。

---

**作成日**: 2025-10-13
**関連**: B-3, B-4実装仕様